# ğŸ› ï¸ OPML Gardener å¼€å‘æ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
- [æ ¸å¿ƒæ¨¡å—](#æ ¸å¿ƒæ¨¡å—)
- [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
- [æ‰©å±•åŠŸèƒ½](#æ‰©å±•åŠŸèƒ½)

---

## ğŸ“– é¡¹ç›®æ¦‚è¿°

OPML Gardener æ˜¯ä¸€ä¸ªåŸºäº Next.js 14 çš„å•é¡µåº”ç”¨ï¼Œç”¨äºç®¡ç† RSS è®¢é˜…çš„ OPML æ–‡ä»¶ã€‚æ‰€æœ‰æ•°æ®å¤„ç†éƒ½åœ¨å®¢æˆ·ç«¯å®Œæˆï¼Œæ— éœ€åç«¯æœåŠ¡å™¨ã€‚

### è®¾è®¡åŸåˆ™

1. **éšç§ä¼˜å…ˆ**ï¼šæ‰€æœ‰æ•°æ®åœ¨æµè§ˆå™¨æœ¬åœ°å¤„ç†
2. **ç®€æ´ç›´è§‚**ï¼šæ¸…æ™°çš„ UIï¼Œæ˜“äºä½¿ç”¨
3. **ç±»å‹å®‰å…¨**ï¼šå…¨é¢ä½¿ç”¨ TypeScript
4. **å¯ç»´æŠ¤æ€§**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£åˆ†ç¦»

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æŠ€æœ¯æ ˆ

```
å‰ç«¯æ¡†æ¶ï¼šNext.js 14 (App Router)
è¯­è¨€ï¼šTypeScript
æ ·å¼ï¼šTailwind CSS
UI ç»„ä»¶ï¼šshadcn/ui
çŠ¶æ€ç®¡ç†ï¼šReact Hooks
XML å¤„ç†ï¼šfast-xml-parser
å›¾æ ‡ï¼šLucide React
```

### é¡¹ç›®ç»“æ„

```
OPMLGardener/
â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”œâ”€â”€ layout.tsx         # æ ¹å¸ƒå±€ï¼Œå®šä¹‰å…¨å±€ç»“æ„
â”‚   â”œâ”€â”€ page.tsx           # ä¸»é¡µé¢ï¼ˆDashboardï¼‰
â”‚   â””â”€â”€ globals.css        # å…¨å±€æ ·å¼ï¼ŒTailwind é…ç½®
â”‚
â”œâ”€â”€ components/            # React ç»„ä»¶
â”‚   â”œâ”€â”€ ui/               # shadcn/ui åŸºç¡€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”œâ”€â”€ select.tsx
â”‚   â”‚   â””â”€â”€ badge.tsx
â”‚   â”œâ”€â”€ OpmlUploader.tsx  # æ–‡ä»¶ä¸Šä¼ ç»„ä»¶
â”‚   â”œâ”€â”€ FeedTable.tsx     # è®¢é˜…æºè¡¨æ ¼
â”‚   â””â”€â”€ FilterSidebar.tsx # ç­›é€‰ä¾§è¾¹æ 
â”‚
â”œâ”€â”€ hooks/                # è‡ªå®šä¹‰ React Hooks
â”‚   â””â”€â”€ useOpml.ts        # OPML çŠ¶æ€ç®¡ç†æ ¸å¿ƒ
â”‚
â”œâ”€â”€ lib/                  # å·¥å…·å‡½æ•°åº“
â”‚   â”œâ”€â”€ utils.ts          # é€šç”¨å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ opml-parser.ts    # OPML è§£æå’Œå¯¼å‡ºé€»è¾‘
â”‚
â””â”€â”€ types/                # TypeScript ç±»å‹å®šä¹‰
    â””â”€â”€ index.ts          # æ•°æ®æ¨¡å‹å®šä¹‰
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—

### 1. æ•°æ®æ¨¡å‹ (`types/index.ts`)

```typescript
export type FeedItem = {
  id: string;          // å”¯ä¸€æ ‡è¯†
  title: string;       // è®¢é˜…æºæ ‡é¢˜
  xmlUrl: string;      // RSS è®¢é˜…åœ°å€
  htmlUrl?: string;    // ç½‘ç«™åœ°å€
  category: string;    // åˆ†ç±»åç§°
  originalData?: any;  // åŸå§‹ OPML æ•°æ®
  isSelected: boolean; // é€‰ä¸­çŠ¶æ€
};
```

**è®¾è®¡è¯´æ˜**ï¼š
- `id` ä½¿ç”¨éšæœºç”Ÿæˆï¼Œç¡®ä¿å”¯ä¸€æ€§
- `category` ä» OPML çš„çˆ¶çº§ `<outline>` æå–
- `isSelected` ç”¨äºæ‰¹é‡æ“ä½œ

### 2. OPML è§£æå™¨ (`lib/opml-parser.ts`)

#### `parseOpml(xmlContent: string): FeedItem[]`

**åŠŸèƒ½**ï¼šè§£æ OPML XML å­—ç¬¦ä¸²ï¼Œæå–è®¢é˜…æº

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. ä½¿ç”¨ `fast-xml-parser` è§£æ XML
2. éå† `<body>` ä¸‹çš„ `<outline>` å…ƒç´ 
3. é¡¶å±‚ `<outline>` ä½œä¸ºåˆ†ç±»
4. åµŒå¥—çš„ `<outline>` ä½œä¸ºè®¢é˜…æº
5. æå– `text`ã€`xmlUrl`ã€`htmlUrl` å±æ€§

**æ”¯æŒçš„ OPML ç»“æ„**ï¼š
```xml
<opml version="2.0">
  <body>
    <outline text="åˆ†ç±»å">
      <outline text="æ ‡é¢˜" xmlUrl="..." htmlUrl="..." />
    </outline>
  </body>
</opml>
```

#### `exportOpml(feeds: FeedItem[]): string`

**åŠŸèƒ½**ï¼šå°† FeedItem æ•°ç»„è½¬æ¢å› OPML XML

**æ ¸å¿ƒé€»è¾‘**ï¼š
1. æŒ‰ `category` å­—æ®µåˆ†ç»„
2. æ„å»ºåµŒå¥—çš„ OPML ç»“æ„
3. ä½¿ç”¨ `XMLBuilder` ç”Ÿæˆ XML å­—ç¬¦ä¸²

#### `downloadOpml(content: string, filename: string): void`

**åŠŸèƒ½**ï¼šè§¦å‘æµè§ˆå™¨ä¸‹è½½ OPML æ–‡ä»¶

**å®ç°**ï¼š
1. åˆ›å»º Blob å¯¹è±¡
2. ç”Ÿæˆä¸´æ—¶ URL
3. åˆ›å»º `<a>` å…ƒç´ è§¦å‘ä¸‹è½½
4. æ¸…ç†èµ„æº

### 3. çŠ¶æ€ç®¡ç† Hook (`hooks/useOpml.ts`)

`useOpml` æ˜¯åº”ç”¨çš„æ ¸å¿ƒçŠ¶æ€ç®¡ç†å™¨ã€‚

#### çŠ¶æ€

```typescript
const [feeds, setFeeds] = useState<FeedItem[]>([]);
const [searchQuery, setSearchQuery] = useState("");
const [selectedCategory, setSelectedCategory] = useState<string>("all");
```

#### æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ | å‚æ•° | è¿”å›å€¼ |
|------|------|------|--------|
| `importOpml` | å¯¼å…¥ OPML æ–‡ä»¶ | `fileContent: string` | `{ success, count, error? }` |
| `exportFeeds` | å¯¼å‡ºè®¢é˜…æº | `selectedOnly: boolean` | `{ success, count, error? }` |
| `updateFeed` | æ›´æ–°å•ä¸ªè®¢é˜…æº | `id, updates` | `void` |
| `deleteFeed` | åˆ é™¤è®¢é˜…æº | `id: string` | `void` |
| `toggleFeedSelection` | åˆ‡æ¢é€‰ä¸­çŠ¶æ€ | `id: string` | `void` |
| `toggleAllSelection` | å…¨é€‰/å–æ¶ˆå…¨é€‰ | `selected: boolean` | `void` |
| `removeDuplicates` | å»é™¤é‡å¤ | - | `number` (åˆ é™¤æ•°é‡) |

#### è®¡ç®—å±æ€§

```typescript
// ç­›é€‰åçš„è®¢é˜…æºï¼ˆåŸºäºæœç´¢å’Œåˆ†ç±»ï¼‰
const filteredFeeds = useMemo(() => { ... }, [feeds, searchQuery, selectedCategory]);

// å”¯ä¸€åˆ†ç±»åˆ—è¡¨
const categories = useMemo(() => { ... }, [feeds]);

// ç»Ÿè®¡ä¿¡æ¯
const stats: OpmlStats = useMemo(() => { ... }, [feeds, categories]);
```

### 4. UI ç»„ä»¶

#### `OpmlUploader.tsx`

**åŠŸèƒ½**ï¼šæ‹–æ‹½/ç‚¹å‡»ä¸Šä¼  OPML æ–‡ä»¶

**ç‰¹æ€§**ï¼š
- æ”¯æŒæ‹–æ‹½ä¸Šä¼ 
- æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆ.opmlï¼‰
- è§†è§‰åé¦ˆï¼ˆæ‹–æ‹½çŠ¶æ€ï¼‰

#### `FeedTable.tsx`

**åŠŸèƒ½**ï¼šä»¥è¡¨æ ¼å½¢å¼å±•ç¤ºå’Œç¼–è¾‘è®¢é˜…æº

**åˆ—**ï¼š
- å¤é€‰æ¡† - é€‰ä¸­çŠ¶æ€
- åˆ†ç±» - ä¸‹æ‹‰é€‰æ‹©å™¨
- æ ‡é¢˜ - æ–‡æœ¬è¾“å…¥
- RSS é“¾æ¥ - æ–‡æœ¬è¾“å…¥
- ç½‘ç«™é“¾æ¥ - æ–‡æœ¬è¾“å…¥
- æ“ä½œ - åˆ é™¤ã€æ‰“å¼€é“¾æ¥

**ç‰¹æ€§**ï¼š
- å®æ—¶ç¼–è¾‘
- å…¨é€‰åŠŸèƒ½
- ç©ºçŠ¶æ€æç¤º

#### `FilterSidebar.tsx`

**åŠŸèƒ½**ï¼šæœç´¢å’Œåˆ†ç±»ç­›é€‰

**ç‰¹æ€§**ï¼š
- å…¨å±€æœç´¢
- åˆ†ç±»å¿«é€Ÿç­›é€‰
- "å…¨éƒ¨åˆ†ç±»" é€‰é¡¹

---

## ğŸ’» å¼€å‘æŒ‡å—

### ç¯å¢ƒè¦æ±‚

- Node.js 18.17 æˆ–æ›´é«˜ç‰ˆæœ¬
- npm æˆ– yarn æˆ– pnpm

### å¼€å‘æµç¨‹

1. **å®‰è£…ä¾èµ–**
```bash
npm install
```

2. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
```bash
npm run dev
```

3. **ä»£ç æ£€æŸ¥**
```bash
npm run lint
```

4. **æ„å»ºç”Ÿäº§ç‰ˆæœ¬**
```bash
npm run build
```

### ä»£ç è§„èŒƒ

#### TypeScript

- æ‰€æœ‰å‡½æ•°å¿…é¡»æœ‰æ˜ç¡®çš„ç±»å‹å®šä¹‰
- ä½¿ç”¨æ¥å£å®šä¹‰ç»„ä»¶ Props
- é¿å…ä½¿ç”¨ `any`ï¼Œå¿…è¦æ—¶ä½¿ç”¨ `unknown`

#### React

- ä¼˜å…ˆä½¿ç”¨å‡½æ•°ç»„ä»¶
- ä½¿ç”¨ Hooks ç®¡ç†çŠ¶æ€
- ç»„ä»¶èŒè´£å•ä¸€
- Props è§£æ„å¹¶æ·»åŠ ç±»å‹

#### æ ·å¼

- ä½¿ç”¨ Tailwind CSS utility classes
- é¿å…å†…è”æ ·å¼
- ä½¿ç”¨ `cn()` å‡½æ•°åˆå¹¶ class

### Git æäº¤è§„èŒƒ

```
feat: æ–°åŠŸèƒ½
fix: ä¿®å¤ bug
docs: æ–‡æ¡£æ›´æ–°
style: ä»£ç æ ¼å¼è°ƒæ•´
refactor: é‡æ„
test: æµ‹è¯•ç›¸å…³
chore: æ„å»º/å·¥å…·ç›¸å…³
```

---

## ğŸš€ æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ æ–°çš„å¯¼å‡ºæ ¼å¼ï¼ˆå¦‚ JSONï¼‰

**æ­¥éª¤**ï¼š

1. åœ¨ `lib/opml-parser.ts` æ·»åŠ å¯¼å‡ºå‡½æ•°ï¼š

```typescript
export function exportJson(feeds: FeedItem[]): string {
  return JSON.stringify(feeds, null, 2);
}

export function downloadJson(content: string, filename = "feeds.json"): void {
  const blob = new Blob([content], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}
```

2. åœ¨ `hooks/useOpml.ts` æ·»åŠ æ–¹æ³•ï¼š

```typescript
const exportAsJson = () => {
  const jsonContent = exportJson(feeds);
  downloadJson(jsonContent);
};

return {
  // ... å…¶ä»–æ–¹æ³•
  exportAsJson,
};
```

3. åœ¨ `app/page.tsx` æ·»åŠ æŒ‰é’®ï¼š

```tsx
<Button onClick={exportAsJson}>
  å¯¼å‡ºä¸º JSON
</Button>
```

### 2. å®ç°æ’¤é”€/é‡åšåŠŸèƒ½

ä½¿ç”¨å†å²è®°å½•æ ˆï¼š

```typescript
const [history, setHistory] = useState<FeedItem[][]>([]);
const [historyIndex, setHistoryIndex] = useState(-1);

const saveToHistory = (newFeeds: FeedItem[]) => {
  const newHistory = history.slice(0, historyIndex + 1);
  setHistory([...newHistory, newFeeds]);
  setHistoryIndex(newHistory.length);
};

const undo = () => {
  if (historyIndex > 0) {
    setHistoryIndex(historyIndex - 1);
    setFeeds(history[historyIndex - 1]);
  }
};

const redo = () => {
  if (historyIndex < history.length - 1) {
    setHistoryIndex(historyIndex + 1);
    setFeeds(history[historyIndex + 1]);
  }
};
```

### 3. æ·»åŠ  RSS é“¾æ¥éªŒè¯

åœ¨ `lib/opml-parser.ts` æ·»åŠ éªŒè¯å‡½æ•°ï¼š

```typescript
export function validateRssUrl(url: string): {
  isValid: boolean;
  error?: string;
} {
  // æ£€æŸ¥ URL æ ¼å¼
  try {
    const parsedUrl = new URL(url);
    if (!parsedUrl.protocol.startsWith("http")) {
      return { isValid: false, error: "å¿…é¡»æ˜¯ HTTP/HTTPS é“¾æ¥" };
    }
    return { isValid: true };
  } catch {
    return { isValid: false, error: "æ— æ•ˆçš„ URL æ ¼å¼" };
  }
}
```

åœ¨ `FeedTable.tsx` ä¸­ä½¿ç”¨ï¼š

```tsx
const validation = validateRssUrl(feed.xmlUrl);
<Input
  value={feed.xmlUrl}
  className={cn(
    "h-9 font-mono text-xs",
    !validation.isValid && "border-red-500"
  )}
/>
{!validation.isValid && (
  <p className="text-xs text-red-500">{validation.error}</p>
)}
```

### 4. å®ç°æ·±è‰²æ¨¡å¼

1. å®‰è£… `next-themes`ï¼š
```bash
npm install next-themes
```

2. åœ¨ `app/layout.tsx` æ·»åŠ  ThemeProviderï¼š

```tsx
import { ThemeProvider } from "next-themes";

export default function RootLayout({ children }) {
  return (
    <html lang="zh-CN" suppressHydrationWarning>
      <body>
        <ThemeProvider attribute="class">
          {children}
        </ThemeProvider>
      </body>
    </html>
  );
}
```

3. æ·»åŠ ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼š

```tsx
import { useTheme } from "next-themes";

function ThemeToggle() {
  const { theme, setTheme } = useTheme();
  
  return (
    <Button
      onClick={() => setTheme(theme === "dark" ? "light" : "dark")}
    >
      {theme === "dark" ? "ğŸŒ" : "ğŸŒ™"}
    </Button>
  );
}
```

### 5. æ·»åŠ æ‰¹é‡ç¼–è¾‘åˆ†ç±»åŠŸèƒ½

åœ¨ `hooks/useOpml.ts` ä¸­å·²æœ‰ `bulkUpdateCategory` æ–¹æ³•ï¼š

```typescript
const bulkUpdateCategory = (feedIds: string[], newCategory: string) => {
  setFeeds((prev) =>
    prev.map((feed) =>
      feedIds.includes(feed.id) ? { ...feed, category: newCategory } : feed
    )
  );
};
```

åœ¨ `app/page.tsx` æ·»åŠ  UIï¼š

```tsx
{stats.selectedFeeds > 0 && (
  <div className="flex items-center gap-2">
    <Select
      onChange={(e) => {
        const selectedIds = feeds
          .filter(f => f.isSelected)
          .map(f => f.id);
        bulkUpdateCategory(selectedIds, e.target.value);
      }}
    >
      <option value="">é€‰æ‹©åˆ†ç±»</option>
      {categories.map(cat => (
        <option key={cat} value={cat}>{cat}</option>
      ))}
    </Select>
    <Button>æ‰¹é‡æ›´æ”¹åˆ†ç±»</Button>
  </div>
)}
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

ä½¿ç”¨ Jest å’Œ React Testing Libraryï¼š

```bash
npm install -D jest @testing-library/react @testing-library/jest-dom
```

æµ‹è¯•ç¤ºä¾‹ï¼š

```typescript
// __tests__/opml-parser.test.ts
import { parseOpml, exportOpml } from '@/lib/opml-parser';

describe('OPML Parser', () => {
  it('should parse valid OPML', () => {
    const xml = `<?xml version="1.0"?>
      <opml version="2.0">
        <body>
          <outline text="Category">
            <outline text="Feed" xmlUrl="https://example.com/feed.xml" />
          </outline>
        </body>
      </opml>`;
    
    const feeds = parseOpml(xml);
    expect(feeds).toHaveLength(1);
    expect(feeds[0].category).toBe('Category');
  });
});
```

### E2E æµ‹è¯•

ä½¿ç”¨ Playwrightï¼š

```bash
npm install -D @playwright/test
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Next.js æ–‡æ¡£](https://nextjs.org/docs)
- [Tailwind CSS æ–‡æ¡£](https://tailwindcss.com/docs)
- [shadcn/ui ç»„ä»¶](https://ui.shadcn.com)
- [fast-xml-parser](https://github.com/NaturalIntelligence/fast-xml-parser)
- [OPML è§„èŒƒ](http://opml.org/spec2.opml)

---

**Happy Coding! ğŸ‰**

